generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USERS & AUTH ====================

enum UserRole {
  ORGANIZER // Владелец организации
  POINT_ADMIN // Админ точки
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  role      UserRole @default(ORGANIZER)
  accountId String? // Организация к которой принадлежит (для сотрудников)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account          Account?       @relation("AccountMembers", fields: [accountId], references: [id])
  ownedAccounts    Account[]      @relation("AccountOwner")
  pointAssignments PointMember[]
  refreshTokens    RefreshToken[]

  @@index([accountId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

// ==================== ACCOUNTS & POINTS ====================

model Account {
  id        String   @id @default(uuid())
  name      String
  ownerId   String
  owner     User     @relation("AccountOwner", fields: [ownerId], references: [id])
  members   User[]   @relation("AccountMembers")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  points   Point[]
  settings OrgSettings?

  @@index([ownerId])
}

model Point {
  id        String   @id @default(uuid())
  name      String
  address   String?
  accountId String
  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  warehouses    Warehouse[]
  members       PointMember[]
  goodsReceipts GoodsReceipt[]
  transfersOut  Transfer[]     @relation("TransferFrom")
  transfersIn   Transfer[]     @relation("TransferTo")
  sales         Sale[]
  debtsOwed     Debt[]         @relation("DebtCreditor")
  debtsOwing    Debt[]         @relation("DebtDebtor")
  paymentsOut   Payment[]      @relation("PaymentFrom")
  paymentsIn    Payment[]      @relation("PaymentTo")

  @@index([accountId])
}

model PointMember {
  id        String   @id @default(uuid())
  pointId   String
  point     Point    @relation(fields: [pointId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      UserRole @default(POINT_ADMIN)
  createdAt DateTime @default(now())

  @@unique([pointId, userId])
  @@index([pointId])
  @@index([userId])
}

// ==================== ORGANIZATION SETTINGS ====================

model OrgSettings {
  id                String  @id @default(uuid())
  accountId         String  @unique
  account           Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  canAddEmployees   Boolean @default(true)
  canAddPoints      Boolean @default(true)
  canAddWarehouses  Boolean @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([accountId])
}

// ==================== WAREHOUSES & STOCK ====================

model Warehouse {
  id          String   @id @default(uuid())
  name        String
  pointId     String
  point       Point    @relation(fields: [pointId], references: [id], onDelete: Cascade)
  address     String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stocks Stock[]

  @@index([pointId])
}

model Product {
  id          String   @id @default(uuid())
  name        String
  sku         String   @unique
  barcode     String?
  description String?
  unit        String   @default("шт")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stocks            Stock[]
  goodsReceiptItems GoodsReceiptItem[]
  transferItems     TransferItem[]
  saleItems         SaleItem[]

  @@index([sku])
  @@index([barcode])
}

model Stock {
  id          String    @id @default(uuid())
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  productId   String
  product     Product   @relation(fields: [productId], references: [id])
  quantity    Decimal   @db.Decimal(10, 3)
  costPrice   Decimal   @db.Decimal(12, 2)
  salePrice   Decimal   @db.Decimal(12, 2)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([warehouseId, productId])
  @@index([warehouseId])
  @@index([productId])
}

// ==================== GOODS RECEIPT ====================

model GoodsReceipt {
  id           String             @id @default(uuid())
  number       String             @unique
  pointId      String
  point        Point              @relation(fields: [pointId], references: [id])
  warehouseId  String
  supplierName String?
  totalAmount  Decimal            @db.Decimal(12, 2)
  note         String?
  status       GoodsReceiptStatus @default(PENDING)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  items GoodsReceiptItem[]

  @@index([pointId])
  @@index([number])
}

enum GoodsReceiptStatus {
  PENDING
  COMPLETED
  CANCELLED
}

model GoodsReceiptItem {
  id             String       @id @default(uuid())
  goodsReceiptId String
  goodsReceipt   GoodsReceipt @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  productId      String
  product        Product      @relation(fields: [productId], references: [id])
  quantity       Decimal      @db.Decimal(10, 3)
  costPrice      Decimal      @db.Decimal(12, 2)
  salePrice      Decimal      @db.Decimal(12, 2)
  totalAmount    Decimal      @db.Decimal(12, 2)

  @@index([goodsReceiptId])
  @@index([productId])
}

// ==================== TRANSFERS ====================

model Transfer {
  id          String         @id @default(uuid())
  number      String         @unique
  fromPointId String
  fromPoint   Point          @relation("TransferFrom", fields: [fromPointId], references: [id])
  toPointId   String
  toPoint     Point          @relation("TransferTo", fields: [toPointId], references: [id])
  totalAmount Decimal        @db.Decimal(12, 2)
  status      TransferStatus @default(PENDING)
  note        String?
  sentAt      DateTime?
  confirmedAt DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  items TransferItem[]
  debt  Debt?

  @@index([fromPointId])
  @@index([toPointId])
  @@index([number])
}

enum TransferStatus {
  PENDING
  SENT
  CONFIRMED
  CANCELLED
}

model TransferItem {
  id          String   @id @default(uuid())
  transferId  String
  transfer    Transfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  quantity    Decimal  @db.Decimal(10, 3)
  costPrice   Decimal  @db.Decimal(12, 2)
  salePrice   Decimal  @db.Decimal(12, 2)
  totalAmount Decimal  @db.Decimal(12, 2)

  @@index([transferId])
  @@index([productId])
}

// ==================== SALES ====================

model Sale {
  id          String     @id @default(uuid())
  number      String     @unique
  pointId     String
  point       Point      @relation(fields: [pointId], references: [id])
  warehouseId String
  totalAmount Decimal    @db.Decimal(12, 2)
  totalCost   Decimal    @db.Decimal(12, 2)
  profit      Decimal    @db.Decimal(12, 2)
  status      SaleStatus @default(COMPLETED)
  note        String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  items SaleItem[]

  @@index([pointId])
  @@index([number])
}

enum SaleStatus {
  COMPLETED
  CANCELLED
}

model SaleItem {
  id          String  @id @default(uuid())
  saleId      String
  sale        Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId   String
  product     Product @relation(fields: [productId], references: [id])
  quantity    Decimal @db.Decimal(10, 3)
  costPrice   Decimal @db.Decimal(12, 2)
  salePrice   Decimal @db.Decimal(12, 2)
  totalAmount Decimal @db.Decimal(12, 2)
  profit      Decimal @db.Decimal(12, 2)

  @@index([saleId])
  @@index([productId])
}

// ==================== DEBTS & PAYMENTS ====================

model Debt {
  id              String     @id @default(uuid())
  creditorPointId String
  creditorPoint   Point      @relation("DebtCreditor", fields: [creditorPointId], references: [id])
  debtorPointId   String
  debtorPoint     Point      @relation("DebtDebtor", fields: [debtorPointId], references: [id])
  transferId      String     @unique
  transfer        Transfer   @relation(fields: [transferId], references: [id])
  originalAmount  Decimal    @db.Decimal(12, 2)
  remainingAmount Decimal    @db.Decimal(12, 2)
  status          DebtStatus @default(PENDING)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  payments Payment[]

  @@index([creditorPointId])
  @@index([debtorPointId])
}

enum DebtStatus {
  PENDING
  PARTIAL
  PAID
  CANCELLED
}

model Payment {
  id          String        @id @default(uuid())
  number      String        @unique
  fromPointId String
  fromPoint   Point         @relation("PaymentFrom", fields: [fromPointId], references: [id])
  toPointId   String
  toPoint     Point         @relation("PaymentTo", fields: [toPointId], references: [id])
  debtId      String
  debt        Debt          @relation(fields: [debtId], references: [id])
  amount      Decimal       @db.Decimal(12, 2)
  status      PaymentStatus @default(PENDING)
  note        String?
  confirmedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([fromPointId])
  @@index([toPointId])
  @@index([debtId])
  @@index([number])
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  CANCELLED
}
