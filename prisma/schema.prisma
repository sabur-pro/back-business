generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USERS & AUTH ====================

enum UserRole {
  ORGANIZER // Владелец организации
  POINT_ADMIN // Админ точки
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  role              UserRole @default(ORGANIZER)
  accountId         String? // Организация к которой принадлежит (для сотрудников)
  canCreateShipment Boolean  @default(false)
  canReceiveShipment Boolean @default(false)
  canSell            Boolean  @default(false)
  canAddProducts     Boolean  @default(false)
  canManageCounterparties Boolean @default(false)
  isActive          Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account          Account?       @relation("AccountMembers", fields: [accountId], references: [id])
  ownedAccounts    Account[]      @relation("AccountOwner")
  pointAssignments PointMember[]
  shopAssignments  ShopEmployee[]
  refreshTokens    RefreshToken[]

  @@index([accountId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

// ==================== ACCOUNTS & POINTS ====================

model Account {
  id        String   @id @default(uuid())
  name      String
  ownerId   String
  owner     User     @relation("AccountOwner", fields: [ownerId], references: [id])
  members   User[]   @relation("AccountMembers")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  points       Point[]
  products     Product[]
  settings     OrgSettings?
  counterparties Counterparty[]
  transfersOut   Transfer[] @relation("TransferFromAccount")
  transfersIn    Transfer[] @relation("TransferToAccount")
  debtsOwed      Debt[]     @relation("DebtCreditorAccount")
  debtsOwing     Debt[]     @relation("DebtDebtorAccount")

  @@index([ownerId])
}

model Point {
  id        String   @id @default(uuid())
  name      String
  address   String?
  accountId String
  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  warehouses    Warehouse[]
  members       PointMember[]
  goodsReceipts GoodsReceipt[]
  transfersOut  Transfer[]     @relation("TransferFrom")
  transfersIn   Transfer[]     @relation("TransferTo")
  sales         Sale[]
  debtsOwed     Debt[]         @relation("DebtCreditor")
  debtsOwing    Debt[]         @relation("DebtDebtor")
  paymentsOut   Payment[]      @relation("PaymentFrom")
  paymentsIn    Payment[]      @relation("PaymentTo")

  @@index([accountId])
}

model PointMember {
  id        String   @id @default(uuid())
  pointId   String
  point     Point    @relation(fields: [pointId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      UserRole @default(POINT_ADMIN)
  createdAt DateTime @default(now())

  @@unique([pointId, userId])
  @@index([pointId])
  @@index([userId])
}

// ==================== ORGANIZATION SETTINGS ====================

model OrgSettings {
  id                String  @id @default(uuid())
  accountId         String  @unique
  account           Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  canAddEmployees   Boolean @default(true)
  canAddPoints      Boolean @default(true)
  canAddWarehouses  Boolean @default(true)
  canAddProducts    Boolean @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([accountId])
}

// ==================== WAREHOUSES & SHOPS ====================

enum WarehouseType {
  WAREHOUSE
  SHOP
}

model Warehouse {
  id          String        @id @default(uuid())
  name        String
  type        WarehouseType @default(WAREHOUSE)
  pointId     String
  point       Point         @relation(fields: [pointId], references: [id], onDelete: Cascade)
  address     String?
  description String?
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  stocks        Stock[]
  products      Product[]
  transfersOut  Transfer[]     @relation("TransferFromWarehouse")
  transfersIn   Transfer[]     @relation("TransferToWarehouse")
  shopEmployees ShopEmployee[]
  sales         Sale[]         @relation("SaleShop")
  cashRegister  CashRegister?

  @@index([pointId])
  @@index([type])
}

model ShopEmployee {
  id          String   @id @default(uuid())
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([warehouseId, userId])
  @@index([warehouseId])
  @@index([userId])
}

model Product {
  id            String   @id @default(uuid())
  sku           String   // Артикул (货号)
  photoOriginal String?  // Фото оригинал (физический)
  photo         String?  // Фото товара
  sizeRange     String?  // Код соответствия / размерный ряд (配码), e.g. "41-45/12221"
  boxCount      Int      @default(0) // Количество коробок (件数)
  pairCount     Int      @default(0) // Количество пар (双数)
  priceYuan     Decimal  @db.Decimal(12, 2) // Цена в юанях (单价)
  priceRub      Decimal  @db.Decimal(12, 2) // Цена в рублях
  totalYuan     Decimal  @db.Decimal(12, 2) // Общая сумма в юанях (金额)
  totalRub      Decimal  @db.Decimal(12, 2) // Общая сумма в рублях
  recommendedSalePrice Decimal @default(0) @db.Decimal(12, 2) // Рекомендованная сумма продажи за коробку
  totalRecommendedSale Decimal @default(0) @db.Decimal(12, 2) // Итого рекомендованная сумма продажи
  actualSalePrice      Decimal @default(0) @db.Decimal(12, 2) // Фактическая сумма продажи за коробку
  totalActualSale      Decimal @default(0) @db.Decimal(12, 2) // Итого фактическая сумма продажи
  barcode       String?  // Баркод или QR-код данные
  accountId     String
  account       Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  warehouseId   String?
  warehouse     Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  stocks            Stock[]
  goodsReceiptItems GoodsReceiptItem[]
  transferItems     TransferItem[]
  saleItems         SaleItem[]

  @@unique([sku, accountId, warehouseId])
  @@index([sku])
  @@index([barcode])
  @@index([accountId])
  @@index([warehouseId])
}

model Stock {
  id          String    @id @default(uuid())
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  productId   String?
  product     Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  quantity    Decimal   @db.Decimal(10, 3)
  costPrice   Decimal   @db.Decimal(12, 2)
  salePrice   Decimal   @db.Decimal(12, 2)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([warehouseId, productId])
  @@index([warehouseId])
  @@index([productId])
}

// ==================== GOODS RECEIPT ====================

model GoodsReceipt {
  id           String             @id @default(uuid())
  number       String             @unique
  pointId      String
  point        Point              @relation(fields: [pointId], references: [id])
  warehouseId  String
  supplierName String?
  supplierId   String?
  supplier     Counterparty?      @relation("GoodsReceiptSupplier", fields: [supplierId], references: [id])
  totalAmount  Decimal            @db.Decimal(12, 2)
  paidAmount   Decimal            @db.Decimal(12, 2) @default(0) // Сколько мы заплатили поставщику
  note         String?
  status       GoodsReceiptStatus @default(PENDING)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  items GoodsReceiptItem[]

  @@index([pointId])
  @@index([supplierId])
  @@index([number])
}

enum GoodsReceiptStatus {
  PENDING
  COMPLETED
  CANCELLED
}

model GoodsReceiptItem {
  id             String       @id @default(uuid())
  goodsReceiptId String
  goodsReceipt   GoodsReceipt @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  productId      String?
  product        Product?     @relation(fields: [productId], references: [id], onDelete: SetNull)
  quantity       Decimal      @db.Decimal(10, 3)
  costPrice      Decimal      @db.Decimal(12, 2)
  salePrice      Decimal      @db.Decimal(12, 2)
  totalAmount    Decimal      @db.Decimal(12, 2)

  @@index([goodsReceiptId])
  @@index([productId])
}

// ==================== TRANSFERS (SHIPMENTS) ====================

model Transfer {
  id                   String         @id @default(uuid())
  number               String         @unique
  fromAccountId        String
  fromAccount          Account        @relation("TransferFromAccount", fields: [fromAccountId], references: [id])
  toAccountId          String
  toAccount            Account        @relation("TransferToAccount", fields: [toAccountId], references: [id])
  fromPointId          String
  fromPoint            Point          @relation("TransferFrom", fields: [fromPointId], references: [id])
  toPointId            String
  toPoint              Point          @relation("TransferTo", fields: [toPointId], references: [id])
  fromWarehouseId      String?
  fromWarehouse        Warehouse?     @relation("TransferFromWarehouse", fields: [fromWarehouseId], references: [id])
  toWarehouseId        String?
  toWarehouse          Warehouse?     @relation("TransferToWarehouse", fields: [toWarehouseId], references: [id])
  totalYuan            Decimal        @db.Decimal(12, 2)
  totalRub             Decimal        @db.Decimal(12, 2)
  waybillPhoto         String?        // Фото накладной при отправке
  transportPhoto       String?        // Фото транспорта
  receiverWaybillPhoto String?        // Фото подписанной накладной при приёмке
  status               TransferStatus @default(PENDING)
  note                 String?
  sentAt               DateTime?
  receivedAt           DateTime?
  confirmedAt          DateTime?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  items TransferItem[]
  debt  Debt?

  @@index([fromAccountId])
  @@index([toAccountId])
  @@index([fromPointId])
  @@index([toPointId])
  @@index([fromWarehouseId])
  @@index([toWarehouseId])
  @@index([number])
}

enum TransferStatus {
  PENDING
  SENT
  CONFIRMED
  CANCELLED
}

model TransferItem {
  id         String   @id @default(uuid())
  transferId String
  transfer   Transfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  productId  String?
  product    Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  sku        String   // Артикул товара (копия на момент отправки)
  photo      String?  // Фото товара (копия)
  sizeRange  String?  // Размерный ряд (копия)
  boxCount   Int      @default(0) // Количество коробок
  pairCount  Int      @default(0) // Количество пар
  priceYuan  Decimal  @db.Decimal(12, 2)
  priceRub   Decimal  @db.Decimal(12, 2)
  totalYuan  Decimal  @db.Decimal(12, 2)
  totalRub   Decimal  @db.Decimal(12, 2)

  @@index([transferId])
  @@index([productId])
}

// ==================== SALES ====================

enum PaymentMethod {
  CASH  // Наличные
  CARD  // Карта
}

model Sale {
  id               String         @id @default(uuid())
  number           String         @unique
  pointId          String
  point            Point          @relation(fields: [pointId], references: [id])
  shopId           String
  shop             Warehouse      @relation("SaleShop", fields: [shopId], references: [id])
  accountId        String
  clientId         String?
  client           Counterparty?  @relation("SaleClient", fields: [clientId], references: [id])
  totalYuan        Decimal        @db.Decimal(12, 2)
  totalRub         Decimal        @db.Decimal(12, 2)
  totalRecommended Decimal        @db.Decimal(12, 2)
  totalActual      Decimal        @db.Decimal(12, 2)
  paidAmount       Decimal        @db.Decimal(12, 2) @default(0) // Сколько клиент заплатил
  paymentMethod    PaymentMethod  @default(CASH) // Тип оплаты
  profit           Decimal        @db.Decimal(12, 2)
  status           SaleStatus     @default(COMPLETED)
  note             String?
  soldById         String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  items SaleItem[]

  @@index([pointId])
  @@index([shopId])
  @@index([accountId])
  @@index([clientId])
  @@index([number])
}

enum SaleStatus {
  COMPLETED
  CANCELLED
}

model SaleItem {
  id                   String  @id @default(uuid())
  saleId               String
  sale                 Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId            String?
  product              Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  sku                  String
  photo                String?
  sizeRange            String?
  boxCount             Int     @default(0)
  pairCount            Int     @default(0)
  priceYuan            Decimal @db.Decimal(12, 2)
  priceRub             Decimal @db.Decimal(12, 2)
  totalYuan            Decimal @db.Decimal(12, 2)
  totalRub             Decimal @db.Decimal(12, 2)
  recommendedSalePrice Decimal @db.Decimal(12, 2)
  actualSalePrice      Decimal @db.Decimal(12, 2)
  totalRecommended     Decimal @db.Decimal(12, 2)
  totalActual          Decimal @db.Decimal(12, 2)
  profit               Decimal @db.Decimal(12, 2)

  @@index([saleId])
  @@index([productId])
}

// ==================== COUNTERPARTIES (SUPPLIERS & CLIENTS) ====================

enum CounterpartyType {
  SUPPLIER // Поставщик
  CLIENT   // Клиент
}

model Counterparty {
  id        String           @id @default(uuid())
  name      String
  phone     String?
  note      String?
  type      CounterpartyType
  accountId String
  account   Account          @relation(fields: [accountId], references: [id], onDelete: Cascade)
  balance   Decimal          @db.Decimal(12, 2) @default(0) // Для SUPPLIER: + мы должны; Для CLIENT: + нам должны
  isActive  Boolean          @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  transactions  CounterpartyTransaction[]
  goodsReceipts GoodsReceipt[] @relation("GoodsReceiptSupplier")
  sales         Sale[]         @relation("SaleClient")

  @@index([accountId])
  @@index([type])
}

enum CounterpartyTransactionType {
  GOODS_RECEIVED // Товар получен от поставщика (увеличивает наш долг)
  GOODS_SOLD     // Товар продан клиенту (увеличивает долг клиента)
  PAYMENT_OUT    // Мы заплатили поставщику (уменьшает наш долг)
  PAYMENT_IN     // Клиент заплатил нам (уменьшает долг клиента)
}

model CounterpartyTransaction {
  id             String                      @id @default(uuid())
  counterpartyId String
  counterparty   Counterparty                @relation(fields: [counterpartyId], references: [id], onDelete: Cascade)
  type           CounterpartyTransactionType
  amount         Decimal                     @db.Decimal(12, 2)
  description    String?
  relatedId      String?
  createdAt      DateTime                    @default(now())

  @@index([counterpartyId])
}

// ==================== CASH REGISTER (КАССА) ====================

model CashRegister {
  id          String    @id @default(uuid())
  shopId      String    @unique
  shop        Warehouse @relation(fields: [shopId], references: [id], onDelete: Cascade)
  balance     Decimal   @db.Decimal(12, 2) @default(0) // Общий баланс (наличные)
  cardBalance Decimal   @db.Decimal(12, 2) @default(0) // Баланс на карте
  safeBalance Decimal   @db.Decimal(12, 2) @default(0) // Баланс в сейфе
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  transactions CashTransaction[]
  expenses     Expense[]
  payouts      Payout[]

  @@index([shopId])
}

enum CashTransactionType {
  SALE_INCOME          // Доход от продажи
  SALE_INCOME_CARD     // Доход от продажи (карта)
  PAYMENT_TO_SUPPLIER  // Оплата поставщику
  PAYMENT_FROM_CLIENT  // Получение от клиента
  EXPENSE              // Расход
  ADJUSTMENT           // Корректировка
  TRANSFER_TO_SAFE     // Перевод в сейф (из налички)
  TRANSFER_FROM_SAFE   // Перевод из сейфа
  CARD_TO_SAFE         // Перевод с карты в сейф
  SAFE_TO_CARD         // Перевод из сейфа на карту
  PAYOUT_CASH          // Выдача организатору (наличные)
  PAYOUT_SAFE          // Выдача организатору (сейф)
  PAYOUT_CARD          // Выдача организатору (карта)
}

model CashTransaction {
  id             String              @id @default(uuid())
  cashRegisterId String
  cashRegister   CashRegister        @relation(fields: [cashRegisterId], references: [id], onDelete: Cascade)
  type           CashTransactionType
  amount         Decimal             @db.Decimal(12, 2)
  description    String?
  counterpartyId String?
  relatedId      String?
  createdAt      DateTime            @default(now())

  @@index([cashRegisterId])
}

// ==================== EXPENSES (РАСХОДЫ) ====================

model Expense {
  id             String       @id @default(uuid())
  cashRegisterId String
  cashRegister   CashRegister @relation(fields: [cashRegisterId], references: [id], onDelete: Cascade)
  category       String       // Категория: обед, грузчик, и т.д.
  amount         Decimal      @db.Decimal(12, 2)
  description    String?
  paymentMethod  PaymentMethod @default(CASH) // Из какого источника (наличные/карта)
  createdById    String?
  createdAt      DateTime     @default(now())

  @@index([cashRegisterId])
  @@index([category])
}

// ==================== PAYOUTS (ВЫДАЧА ОРГАНИЗАТОРУ) ====================

enum PayoutStatus {
  PENDING    // Ожидает подтверждения
  APPROVED   // Одобрено организатором
  REJECTED   // Отклонено
}

model Payout {
  id             String       @id @default(uuid())
  number         String       @unique
  cashRegisterId String
  cashRegister   CashRegister @relation(fields: [cashRegisterId], references: [id], onDelete: Cascade)
  shopId         String
  accountId      String
  cashAmount     Decimal      @db.Decimal(12, 2) @default(0) // Сумма наличными
  safeAmount     Decimal      @db.Decimal(12, 2) @default(0) // Сумма из сейфа
  cardAmount     Decimal      @db.Decimal(12, 2) @default(0) // Сумма на карту
  totalAmount    Decimal      @db.Decimal(12, 2)             // Общая сумма выдачи
  status         PayoutStatus @default(PENDING)
  note           String?
  createdById    String?      // Кто создал выдачу
  approvedById   String?      // Кто одобрил (организатор)
  approvedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([cashRegisterId])
  @@index([shopId])
  @@index([accountId])
  @@index([status])
  @@index([number])
}

// ==================== DEBTS & PAYMENTS ====================

model Debt {
  id                 String     @id @default(uuid())
  creditorAccountId  String
  creditorAccount    Account    @relation("DebtCreditorAccount", fields: [creditorAccountId], references: [id])
  debtorAccountId    String
  debtorAccount      Account    @relation("DebtDebtorAccount", fields: [debtorAccountId], references: [id])
  creditorPointId    String
  creditorPoint      Point      @relation("DebtCreditor", fields: [creditorPointId], references: [id])
  debtorPointId      String
  debtorPoint        Point      @relation("DebtDebtor", fields: [debtorPointId], references: [id])
  transferId         String     @unique
  transfer           Transfer   @relation(fields: [transferId], references: [id])
  originalAmountYuan Decimal    @db.Decimal(12, 2)
  originalAmountRub  Decimal    @db.Decimal(12, 2)
  remainingAmountYuan Decimal   @db.Decimal(12, 2)
  remainingAmountRub  Decimal   @db.Decimal(12, 2)
  status             DebtStatus @default(PENDING)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  payments Payment[]

  @@index([creditorAccountId])
  @@index([debtorAccountId])
  @@index([creditorPointId])
  @@index([debtorPointId])
}

enum DebtStatus {
  PENDING
  PARTIAL
  PAID
  CANCELLED
}

model Payment {
  id          String        @id @default(uuid())
  number      String        @unique
  fromPointId String
  fromPoint   Point         @relation("PaymentFrom", fields: [fromPointId], references: [id])
  toPointId   String
  toPoint     Point         @relation("PaymentTo", fields: [toPointId], references: [id])
  debtId      String
  debt        Debt          @relation(fields: [debtId], references: [id])
  amount      Decimal       @db.Decimal(12, 2)
  status      PaymentStatus @default(PENDING)
  note        String?
  confirmedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([fromPointId])
  @@index([toPointId])
  @@index([debtId])
  @@index([number])
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  CANCELLED
}
